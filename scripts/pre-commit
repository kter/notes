#!/bin/sh
# pre-commit hook for notes project
# Runs backend tests and frontend lint/type checks before commit

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

# Get the root directory of the project
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Backend tests
echo ""
echo "${YELLOW}[1/4] Running backend tests...${NC}"
cd "$PROJECT_ROOT/backend"

# Check if uv is available
if command -v uv &> /dev/null; then
    if uv run python -m pytest -q --tb=no; then
        echo "${GREEN}✓ Backend tests passed${NC}"
    else
        echo "${RED}✗ Backend tests failed${NC}"
        FAILED=1
    fi
else
    echo "${YELLOW}⚠ uv not found, skipping backend tests${NC}"
fi

# Frontend lint
echo ""
echo "${YELLOW}[2/4] Running frontend lint...${NC}"
cd "$PROJECT_ROOT/frontend"

if npm run lint --silent 2>/dev/null; then
    echo "${GREEN}✓ Frontend lint passed${NC}"
else
    echo "${RED}✗ Frontend lint failed${NC}"
    FAILED=1
fi

# Frontend unit tests
echo ""
echo "${YELLOW}[3/4] Running frontend unit tests...${NC}"
# Use run to exclude watch mode if needed, though 'vitest run' is implicit in CI=true or just 'vitest run'. 
# Standard 'npm run test' usually runs 'vitest' which is watch mode by default in dev.
# We should ensure package.json script is 'vitest run' or pass argument here.
# Let's check package.json "test": "vitest" -> this defaults to watch in dev.
# Force single run with 'npm run test -- --run'
if npm run test -- --run --silent 2>/dev/null; then
    echo "${GREEN}✓ Frontend unit tests passed${NC}"
else
    echo "${RED}✗ Frontend unit tests failed${NC}"
    FAILED=1
fi

# Backend lint (ruff)
echo ""
echo "${YELLOW}[4/4] Running backend lint (ruff)...${NC}"
cd "$PROJECT_ROOT/backend"

if command -v uv &> /dev/null; then
    if uv run ruff check --quiet .; then
        echo "${GREEN}✓ Backend lint passed${NC}"
    else
        echo "${RED}✗ Backend lint failed${NC}"
        FAILED=1
    fi
else
    echo "${YELLOW}⚠ uv not found, skipping backend lint${NC}"
fi

# Summary
echo ""
if [ $FAILED -eq 0 ]; then
    echo "${GREEN}All pre-commit checks passed!${NC}"
    exit 0
else
    echo "${RED}Some checks failed. Commit aborted.${NC}"
    echo "Fix the issues above and try again."
    exit 1
fi
